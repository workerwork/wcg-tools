#!/bin/bash -
#########################################################################################
# aicap.sh
# version:3.1
# update:20180523
#########################################################################################
function aicap() {
    file_esp_sa=/root/.wireshark/esp_sa
    echo "# This file is automatically generated, DO NOT MODIFY." > $file_esp_sa
    ipaddr_type="IPv4"
    enc_type="AES-CBC [RFC3602]"
    auth_type="HMAC-SHA-1-96 [RFC2404]"
    declare -A ipaddr_src
    declare -A ipaddr_dst
    declare -A spi
    declare -A enc
    declare -A auth
    num=$(ip xfrm state | grep spi | wc -l)
    for((i=1;i<=$num;i++));
    do
        ipaddr_src[$i]=$(ip xfrm state | grep src | awk 'NR=="'$i'" {print $2}')
        ipaddr_dst[$i]=$(ip xfrm state | grep dst | awk 'NR=="'$i'" {print $4}')
        spi[$i]=$(ip xfrm state | grep spi | awk 'NR=="'$i'" {print $4}')
        enc[$i]=$(ip xfrm state | grep enc | awk 'NR=="'$i'" {print $3}')
        auth[$i]=$(ip xfrm state | grep auth | awk 'NR=="'$i'" {print $3}')
        printf "\"$ipaddr_type\",\"${ipaddr_src[$i]}\",\"${ipaddr_dst[$i]}\",\"${spi[$i]}\",\"$enc_type\",\"${enc[$i]}\",\"$auth_type\",\"${auth[$i]}\"\n" >> $file_esp_sa
    done
}


aicap
wireshark
